name: ZAP Full Coverage Test

on:
  workflow_dispatch:

permissions:
  actions: read
  checks: write
  pull-requests: write
  security-events: write
  id-token: write
  contents: read

# Full Coverage with Minimal External Pings:
# - 4 scans: juice-shop (Docker) - vulnerable app, tests baseline/full/thresholds
# - 1 scan: podinfo (Docker) - clean app, validates low false-positives
# - 1 scan: external URL - verifies URL mode works
# Total: 6 scans, only 1 external ping

jobs:
  vulnerable-app:
    name: "Vulnerable App (4 scans)"
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/full-coverage.yml
    secrets: inherit

  clean-app:
    name: "Clean App (1 scan)"
    needs: vulnerable-app
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/clean-app.yml
    secrets: inherit

  external-url:
    name: "External URL (1 scan)"
    needs: clean-app
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/url-verify.yml
    secrets: inherit

  report:
    name: "Final Report"
    runs-on: ubuntu-latest
    needs: [vulnerable-app, clean-app, external-url]
    if: always()
    steps:
      - name: Generate Summary
        env:
          VULN: ${{ needs.vulnerable-app.result }}
          CLEAN: ${{ needs.clean-app.result }}
          URL: ${{ needs.external-url.result }}
        run: |
          PASSED=0
          FAILED=0
          for r in "$VULN" "$CLEAN" "$URL"; do
            [ "$r" = "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          done

          [ $FAILED -eq 0 ] && STATUS="GO" || STATUS="NO-GO"
          [ "$STATUS" = "GO" ] && ICON="[PASS]" || ICON="[FAIL]"

          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ZAP Full Coverage Test

          **Date:** $(date -u '+%Y-%m-%d %H:%M UTC')

          ---

          ## $ICON DETERMINATION: $STATUS

          **Pass Rate:** $PASSED/3 job groups (6 total scans)

          | Job | Scans | Target | Mode | Result |
          |-----|-------|--------|------|--------|
          | Vulnerable App | 4 | juice-shop | docker | $VULN |
          | Clean App | 1 | podinfo | docker | $CLEAN |
          | External URL | 1 | demo.testfire.net | url | $URL |

          ---

          ### Coverage Matrix

          | # | Test | Type | Threshold | Target |
          |---|------|------|-----------|--------|
          | 1 | baseline-scan | baseline | none | juice-shop |
          | 2 | full-scan | full | none | juice-shop |
          | 3 | threshold-high | baseline | high | juice-shop |
          | 4 | threshold-medium | baseline | medium | juice-shop |
          | 5 | clean-app | baseline | medium | podinfo |
          | 6 | external-url | baseline | none | testfire.net |

          ---

          ### Design Rationale

          | Aspect | Approach |
          |--------|----------|
          | External pings | Only 1 (verifies URL mode) |
          | Docker tests | 5 scans (reliable, reproducible) |
          | Scan types | baseline + full |
          | Thresholds | none, medium, high |
          | False positive check | podinfo (clean app) |
          EOF
