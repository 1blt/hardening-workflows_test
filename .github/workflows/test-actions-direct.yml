name: "Direct Action Tests"

on:
  workflow_call:
    outputs:
      results:
        description: "JSON array of individual test results"
        value: ${{ jobs.collect-results.outputs.results }}

permissions:
  contents: read
  actions: read

jobs:
  # A1: Single public container config
  config-single-public:
    name: "A1: config-single-public"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      matrix: ${{ steps.parse.outputs.matrix }}
      has_containers: ${{ steps.parse.outputs.has_containers }}
      container_count: ${{ steps.parse.outputs.container_count }}
    steps:
      - name: Checkout test repo
        uses: actions/checkout@v4

      - name: Run parse-container-config
        id: parse
        uses: huntridge-labs/hardening-workflows/.github/actions/parse-container-config@feat/migrate-to-composite-actions
        with:
          config_file: tests/configs/single-public.yml

      - name: Validate outputs
        run: |
          echo "matrix=${{ steps.parse.outputs.matrix }}"
          echo "has_containers=${{ steps.parse.outputs.has_containers }}"
          echo "container_count=${{ steps.parse.outputs.container_count }}"

          FAILURES=0

          # Check has_containers
          if [ "${{ steps.parse.outputs.has_containers }}" != "true" ]; then
            echo "::error::has_containers should be true, got ${{ steps.parse.outputs.has_containers }}"
            FAILURES=$((FAILURES + 1))
          fi

          # Check container_count
          if [ "${{ steps.parse.outputs.container_count }}" != "1" ]; then
            echo "::error::container_count should be 1, got ${{ steps.parse.outputs.container_count }}"
            FAILURES=$((FAILURES + 1))
          fi

          # Check matrix has 1 include entry
          INCLUDE_COUNT=$(echo '${{ steps.parse.outputs.matrix }}' | jq '.include | length')
          if [ "$INCLUDE_COUNT" != "1" ]; then
            echo "::error::matrix.include should have 1 entry, got $INCLUDE_COUNT"
            FAILURES=$((FAILURES + 1))
          fi

          # Check container name
          NAME=$(echo '${{ steps.parse.outputs.matrix }}' | jq -r '.include[0].name')
          if [ "$NAME" != "alpine-test" ]; then
            echo "::error::First container name should be alpine-test, got $NAME"
            FAILURES=$((FAILURES + 1))
          fi

          if [ "$FAILURES" -gt 0 ]; then
            echo "::error::$FAILURES validation(s) failed"
            exit 1
          fi
          echo "All validations passed"

  # A2: Multi-container config
  config-multi-container:
    name: "A2: config-multi-container"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      matrix: ${{ steps.parse.outputs.matrix }}
      scan_matrix: ${{ steps.parse.outputs.scan_matrix }}
    steps:
      - name: Checkout test repo
        uses: actions/checkout@v4

      - name: Run parse-container-config
        id: parse
        uses: huntridge-labs/hardening-workflows/.github/actions/parse-container-config@feat/migrate-to-composite-actions
        with:
          config_file: tests/configs/multi-container.yml

      - name: Validate outputs
        run: |
          FAILURES=0

          # Check container count = 3
          if [ "${{ steps.parse.outputs.container_count }}" != "3" ]; then
            echo "::error::container_count should be 3, got ${{ steps.parse.outputs.container_count }}"
            FAILURES=$((FAILURES + 1))
          fi

          # Check matrix has 3 entries
          MATRIX_COUNT=$(echo '${{ steps.parse.outputs.matrix }}' | jq '.include | length')
          if [ "$MATRIX_COUNT" != "3" ]; then
            echo "::error::matrix should have 3 entries, got $MATRIX_COUNT"
            FAILURES=$((FAILURES + 1))
          fi

          # Check scan_matrix has 6+ entries (nginx=3 scanners + alpine=1 + node=2 = 6)
          SCAN_COUNT=$(echo '${{ steps.parse.outputs.scan_matrix }}' | jq '.include | length')
          if [ "$SCAN_COUNT" -lt 6 ]; then
            echo "::error::scan_matrix should have at least 6 entries, got $SCAN_COUNT"
            FAILURES=$((FAILURES + 1))
          fi

          # Verify container names
          NAMES=$(echo '${{ steps.parse.outputs.matrix }}' | jq -r '.include[].name' | sort | tr '\n' ',')
          EXPECTED="alpine-pinned,nginx-old,node-legacy,"
          if [ "$NAMES" != "$EXPECTED" ]; then
            echo "::error::Container names should be '$EXPECTED', got '$NAMES'"
            FAILURES=$((FAILURES + 1))
          fi

          # Verify allow_failure on node-legacy
          ALLOW=$(echo '${{ steps.parse.outputs.matrix }}' | jq '.include[] | select(.name == "node-legacy") | .allow_failure')
          if [ "$ALLOW" != "true" ]; then
            echo "::error::node-legacy should have allow_failure=true, got $ALLOW"
            FAILURES=$((FAILURES + 1))
          fi

          if [ "$FAILURES" -gt 0 ]; then
            echo "::error::$FAILURES validation(s) failed"
            exit 1
          fi
          echo "All validations passed"

  # A3: Structured image format
  config-structured-image:
    name: "A3: config-structured-image"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout test repo
        uses: actions/checkout@v4

      - name: Run parse-container-config
        id: parse
        uses: huntridge-labs/hardening-workflows/.github/actions/parse-container-config@feat/migrate-to-composite-actions
        with:
          config_file: tests/configs/structured-image.yml

      - name: Validate structured image reference
        run: |
          FAILURES=0

          IMAGE=$(echo '${{ steps.parse.outputs.matrix }}' | jq -r '.include[0].image')
          echo "Resolved image reference: $IMAGE"

          # Image should contain docker.io, library, nginx, and 1.25
          if [[ "$IMAGE" != *"docker.io"* ]] || [[ "$IMAGE" != *"nginx"* ]] || [[ "$IMAGE" != *"1.25"* ]]; then
            echo "::error::Structured image not resolved correctly. Got: $IMAGE"
            echo "::error::Expected to contain docker.io, nginx, and 1.25"
            FAILURES=$((FAILURES + 1))
          fi

          if [ "$FAILURES" -gt 0 ]; then
            exit 1
          fi
          echo "Structured image resolved correctly: $IMAGE"

  # A4: All-options config (exercises full schema: registry, auth, all flags)
  config-all-options:
    name: "A4: config-all-options"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout test repo
        uses: actions/checkout@v4

      - name: Run parse-container-config
        id: parse
        uses: huntridge-labs/hardening-workflows/.github/actions/parse-container-config@feat/migrate-to-composite-actions
        with:
          config_file: tests/configs/all-options.yml

      - name: Validate outputs
        run: |
          FAILURES=0

          # Check has_containers
          if [ "${{ steps.parse.outputs.has_containers }}" != "true" ]; then
            echo "::error::has_containers should be true, got ${{ steps.parse.outputs.has_containers }}"
            FAILURES=$((FAILURES + 1))
          fi

          # Check container_count = 1
          if [ "${{ steps.parse.outputs.container_count }}" != "1" ]; then
            echo "::error::container_count should be 1, got ${{ steps.parse.outputs.container_count }}"
            FAILURES=$((FAILURES + 1))
          fi

          # Verify container name
          NAME=$(echo '${{ steps.parse.outputs.matrix }}' | jq -r '.include[0].name')
          if [ "$NAME" != "full-options-test" ]; then
            echo "::error::Container name should be full-options-test, got $NAME"
            FAILURES=$((FAILURES + 1))
          fi

          # Verify allow_failure is true
          ALLOW=$(echo '${{ steps.parse.outputs.matrix }}' | jq '.include[0].allow_failure')
          if [ "$ALLOW" != "true" ]; then
            echo "::error::allow_failure should be true, got $ALLOW"
            FAILURES=$((FAILURES + 1))
          fi

          # Verify fail_on_severity = high
          SEV=$(echo '${{ steps.parse.outputs.matrix }}' | jq -r '.include[0].fail_on_severity')
          if [ "$SEV" != "high" ]; then
            echo "::error::fail_on_severity should be high, got $SEV"
            FAILURES=$((FAILURES + 1))
          fi

          # Verify all 3 scanners present in scan_matrix
          SCAN_COUNT=$(echo '${{ steps.parse.outputs.scan_matrix }}' | jq '.include | length')
          if [ "$SCAN_COUNT" != "3" ]; then
            echo "::error::scan_matrix should have 3 entries (trivy,grype,syft), got $SCAN_COUNT"
            FAILURES=$((FAILURES + 1))
          fi

          if [ "$FAILURES" -gt 0 ]; then
            echo "::error::$FAILURES validation(s) failed"
            exit 1
          fi
          echo "All all-options validations passed"

  # A5: Invalid config â€” duplicate container names should be rejected
  config-invalid-duplicate:
    name: "A5: config-invalid-duplicate"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout test repo
        uses: actions/checkout@v4

      - name: Run parse-container-config (expect failure)
        id: parse
        continue-on-error: true
        uses: huntridge-labs/hardening-workflows/.github/actions/parse-container-config@feat/migrate-to-composite-actions
        with:
          config_file: tests/configs/invalid-duplicate.yml

      - name: Validate that parsing failed
        run: |
          if [ "${{ steps.parse.outcome }}" = "failure" ]; then
            echo "PASS: Parser correctly rejected invalid config with duplicate names"
          else
            echo "FAIL: Parser should have rejected duplicate container names but returned ${{ steps.parse.outcome }}"
            exit 1
          fi

  # --------------------------------------------------------------------------
  # Collect individual results for the suite summary
  # --------------------------------------------------------------------------
  collect-results:
    name: "Collect Action Test Results"
    runs-on: ubuntu-latest
    if: always()
    needs:
      - config-single-public
      - config-multi-container
      - config-structured-image
      - config-all-options
      - config-invalid-duplicate
    outputs:
      results: ${{ steps.collect.outputs.results }}
    steps:
      - name: Build results JSON
        id: collect
        env:
          A1: ${{ needs.config-single-public.result }}
          A2: ${{ needs.config-multi-container.result }}
          A3: ${{ needs.config-structured-image.result }}
          A4: ${{ needs.config-all-options.result }}
          A5: ${{ needs.config-invalid-duplicate.result }}
        run: |
          to_status() {
            case "$1" in
              success) echo "pass" ;;
              failure) echo "FAIL" ;;
              skipped) echo "skip" ;;
              cancelled) echo "cancel" ;;
              *) echo "unknown" ;;
            esac
          }
          RESULTS=$(jq -n -c \
            --arg a1 "$(to_status "$A1")" \
            --arg a2 "$(to_status "$A2")" \
            --arg a3 "$(to_status "$A3")" \
            --arg a4 "$(to_status "$A4")" \
            --arg a5 "$(to_status "$A5")" \
            '[
              {"id":"A1","name":"config-single-public","detail":"Single public container config parsing + matrix","status":$a1},
              {"id":"A2","name":"config-multi-container","detail":"Multi-container config (3 containers, matrix expansion)","status":$a2},
              {"id":"A3","name":"config-structured-image","detail":"Structured image reference format resolution","status":$a3},
              {"id":"A4","name":"config-all-options","detail":"Full schema config (registry, auth, all flags)","status":$a4},
              {"id":"A5","name":"config-invalid-duplicate","detail":"Duplicate container names correctly rejected","status":$a5}
            ]')
          echo "results=$RESULTS" >> "$GITHUB_OUTPUT"
