name: "Direct Action Tests"

on:
  workflow_call:

permissions:
  contents: read
  actions: read

jobs:
  # A1: Single public container config
  config-single-public:
    name: "A1: config-single-public"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      matrix: ${{ steps.parse.outputs.matrix }}
      has_containers: ${{ steps.parse.outputs.has_containers }}
      container_count: ${{ steps.parse.outputs.container_count }}
    steps:
      - name: Checkout test repo
        uses: actions/checkout@v4

      - name: Run parse-container-config
        id: parse
        uses: huntridge-labs/hardening-workflows/.github/actions/parse-container-config@feat/migrate-to-composite-actions
        with:
          config_file: tests/configs/single-public.yml

      - name: Validate outputs
        run: |
          echo "matrix=${{ steps.parse.outputs.matrix }}"
          echo "has_containers=${{ steps.parse.outputs.has_containers }}"
          echo "container_count=${{ steps.parse.outputs.container_count }}"

          FAILURES=0

          # Check has_containers
          if [ "${{ steps.parse.outputs.has_containers }}" != "true" ]; then
            echo "::error::has_containers should be true, got ${{ steps.parse.outputs.has_containers }}"
            FAILURES=$((FAILURES + 1))
          fi

          # Check container_count
          if [ "${{ steps.parse.outputs.container_count }}" != "1" ]; then
            echo "::error::container_count should be 1, got ${{ steps.parse.outputs.container_count }}"
            FAILURES=$((FAILURES + 1))
          fi

          # Check matrix has 1 include entry
          INCLUDE_COUNT=$(echo '${{ steps.parse.outputs.matrix }}' | jq '.include | length')
          if [ "$INCLUDE_COUNT" != "1" ]; then
            echo "::error::matrix.include should have 1 entry, got $INCLUDE_COUNT"
            FAILURES=$((FAILURES + 1))
          fi

          # Check container name
          NAME=$(echo '${{ steps.parse.outputs.matrix }}' | jq -r '.include[0].name')
          if [ "$NAME" != "alpine-test" ]; then
            echo "::error::First container name should be alpine-test, got $NAME"
            FAILURES=$((FAILURES + 1))
          fi

          if [ "$FAILURES" -gt 0 ]; then
            echo "::error::$FAILURES validation(s) failed"
            exit 1
          fi
          echo "All validations passed"

  # A2: Multi-container config
  config-multi-container:
    name: "A2: config-multi-container"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      matrix: ${{ steps.parse.outputs.matrix }}
      scan_matrix: ${{ steps.parse.outputs.scan_matrix }}
    steps:
      - name: Checkout test repo
        uses: actions/checkout@v4

      - name: Run parse-container-config
        id: parse
        uses: huntridge-labs/hardening-workflows/.github/actions/parse-container-config@feat/migrate-to-composite-actions
        with:
          config_file: tests/configs/multi-container.yml

      - name: Validate outputs
        run: |
          FAILURES=0

          # Check container count = 3
          if [ "${{ steps.parse.outputs.container_count }}" != "3" ]; then
            echo "::error::container_count should be 3, got ${{ steps.parse.outputs.container_count }}"
            FAILURES=$((FAILURES + 1))
          fi

          # Check matrix has 3 entries
          MATRIX_COUNT=$(echo '${{ steps.parse.outputs.matrix }}' | jq '.include | length')
          if [ "$MATRIX_COUNT" != "3" ]; then
            echo "::error::matrix should have 3 entries, got $MATRIX_COUNT"
            FAILURES=$((FAILURES + 1))
          fi

          # Check scan_matrix has 6+ entries (nginx=3 scanners + alpine=1 + node=2 = 6)
          SCAN_COUNT=$(echo '${{ steps.parse.outputs.scan_matrix }}' | jq '.include | length')
          if [ "$SCAN_COUNT" -lt 6 ]; then
            echo "::error::scan_matrix should have at least 6 entries, got $SCAN_COUNT"
            FAILURES=$((FAILURES + 1))
          fi

          # Verify container names
          NAMES=$(echo '${{ steps.parse.outputs.matrix }}' | jq -r '.include[].name' | sort | tr '\n' ',')
          EXPECTED="alpine-pinned,nginx-old,node-legacy,"
          if [ "$NAMES" != "$EXPECTED" ]; then
            echo "::error::Container names should be '$EXPECTED', got '$NAMES'"
            FAILURES=$((FAILURES + 1))
          fi

          # Verify allow_failure on node-legacy
          ALLOW=$(echo '${{ steps.parse.outputs.matrix }}' | jq '.include[] | select(.name == "node-legacy") | .allow_failure')
          if [ "$ALLOW" != "true" ]; then
            echo "::error::node-legacy should have allow_failure=true, got $ALLOW"
            FAILURES=$((FAILURES + 1))
          fi

          if [ "$FAILURES" -gt 0 ]; then
            echo "::error::$FAILURES validation(s) failed"
            exit 1
          fi
          echo "All validations passed"

  # A3: Structured image format
  config-structured-image:
    name: "A3: config-structured-image"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout test repo
        uses: actions/checkout@v4

      - name: Run parse-container-config
        id: parse
        uses: huntridge-labs/hardening-workflows/.github/actions/parse-container-config@feat/migrate-to-composite-actions
        with:
          config_file: tests/configs/structured-image.yml

      - name: Validate structured image reference
        run: |
          FAILURES=0

          IMAGE=$(echo '${{ steps.parse.outputs.matrix }}' | jq -r '.include[0].image')
          echo "Resolved image reference: $IMAGE"

          # Image should contain docker.io, library, nginx, and 1.25
          if [[ "$IMAGE" != *"docker.io"* ]] || [[ "$IMAGE" != *"nginx"* ]] || [[ "$IMAGE" != *"1.25"* ]]; then
            echo "::error::Structured image not resolved correctly. Got: $IMAGE"
            echo "::error::Expected to contain docker.io, nginx, and 1.25"
            FAILURES=$((FAILURES + 1))
          fi

          if [ "$FAILURES" -gt 0 ]; then
            exit 1
          fi
          echo "Structured image resolved correctly: $IMAGE"
