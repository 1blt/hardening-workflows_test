name: "Discover Mode Tests"

on:
  workflow_call:
    outputs:
      results:
        description: "JSON array of individual test results"
        value: ${{ jobs.validate-results.outputs.results }}

permissions:
  contents: read
  security-events: write
  actions: read
  packages: read
  pull-requests: write

# ============================================================================
# Discover mode tests: container-scan.yml finds Dockerfiles in this repo
#
# This repo has 3 Dockerfiles under tests/dockerfiles/:
#   - good/Dockerfile      (FROM alpine:3.18 — builds and scans)
#   - vulnerable/Dockerfile (FROM node:14-slim — builds, has CVEs)
#   - broken/Dockerfile    (FROM nonexistent — fails to pull/build)
#
# The discover job uses: find . -name "Dockerfile*" -not -path "./.git/*"
# So all 3 will be found. The broken one should fail gracefully.
# ============================================================================

jobs:
  # --------------------------------------------------------------------------
  # D1: Discover mixed Dockerfiles (good + vulnerable + broken)
  # --------------------------------------------------------------------------
  d1-discover-mixed:
    name: "D1: discover mixed"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: discover
      scanners: trivy,grype
      fail_on_severity: none
      allow_failure: false

  # --------------------------------------------------------------------------
  # D2: Discover with trivy only
  # --------------------------------------------------------------------------
  d2-discover-trivy-only:
    name: "D2: discover trivy only"
    needs: d1-discover-mixed
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: discover
      scanners: trivy
      fail_on_severity: none
      allow_failure: false

  # --------------------------------------------------------------------------
  # D3: Discover with severity threshold
  # --------------------------------------------------------------------------
  d3-discover-severity:
    name: "D3: discover + severity"
    needs: d2-discover-trivy-only
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: discover
      scanners: trivy,grype
      fail_on_severity: critical
      allow_failure: false

  # --------------------------------------------------------------------------
  # Validation job
  # --------------------------------------------------------------------------
  validate-results:
    name: "Validate Discover Test Results"
    runs-on: ubuntu-latest
    outputs:
      results: ${{ steps.collect.outputs.results }}
    needs:
      - d1-discover-mixed
      - d2-discover-trivy-only
      - d3-discover-severity
    if: always()
    steps:
      - name: Validate test outcomes
        env:
          D1: ${{ needs.d1-discover-mixed.result }}
          D2: ${{ needs.d2-discover-trivy-only.result }}
          D3: ${{ needs.d3-discover-severity.result }}
        run: |
          FAILURES=0

          check() {
            local name="$1" got="$2" expected="$3"
            if [ "$got" = "$expected" ]; then
              echo "PASS $name: $got (expected $expected)"
            else
              echo "FAIL $name: $got (expected $expected)"
              FAILURES=$((FAILURES + 1))
            fi
          }

          echo "============================================"
          echo "Discover Mode Test Validation"
          echo "============================================"
          echo ""

          # D1: Should succeed (allow_failure handles broken build, continue-on-error on matrix)
          check "D1 discover-mixed" "$D1" "success"

          # D2: Should succeed (trivy only)
          check "D2 discover-trivy-only" "$D2" "success"

          # D3: May fail if vulnerable image has criticals
          # Both success and failure are valid outcomes depending on node:14 CVEs
          if [ "$D3" = "success" ] || [ "$D3" = "failure" ]; then
            echo "PASS D3 discover-severity: $D3 (completed - threshold applied)"
          else
            echo "FAIL D3 discover-severity: $D3 (unexpected state)"
            FAILURES=$((FAILURES + 1))
          fi

          echo ""
          echo "============================================"
          TOTAL=3
          PASSED=$((TOTAL - FAILURES))
          echo "Results: $PASSED/$TOTAL passed"
          echo "============================================"

          if [ "$FAILURES" -gt 0 ]; then
            exit 1
          fi

      - name: Build results JSON
        id: collect
        if: always()
        env:
          D1: ${{ needs.d1-discover-mixed.result }}
          D2: ${{ needs.d2-discover-trivy-only.result }}
          D3: ${{ needs.d3-discover-severity.result }}
        run: |
          to_status() {
            local got="$1" expected="$2"
            case "$got" in
              skipped) echo "skip" ;;
              cancelled) echo "cancel" ;;
              *)
                if [ "$got" = "$expected" ]; then
                  echo "pass"
                else
                  echo "FAIL"
                fi
                ;;
            esac
          }
          # D3 accepts both success and failure
          D3_STATUS="pass"
          if [ "$D3" != "success" ] && [ "$D3" != "failure" ]; then
            D3_STATUS="FAIL"
          fi
          RESULTS=$(jq -n -c \
            --arg d1 "$(to_status "$D1" success)" \
            --arg d2 "$(to_status "$D2" success)" \
            --arg d3 "$D3_STATUS" \
            '[
              {"id":"D1","name":"discover mixed","detail":"3 Dockerfiles (good+vulnerable+broken) with trivy,grype","status":$d1},
              {"id":"D2","name":"discover trivy only","detail":"Dockerfile discovery with trivy scanner only","status":$d2},
              {"id":"D3","name":"discover + severity","detail":"Dockerfile discovery with critical severity threshold","status":$d3}
            ]')
          echo "results=$RESULTS" >> "$GITHUB_OUTPUT"
