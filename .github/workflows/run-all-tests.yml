name: Run All ZAP Tests

on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        type: choice
        options:
          - all
          - basic
        default: 'all'
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  actions: read
  checks: write
  pull-requests: write
  security-events: write
  id-token: write
  contents: read

jobs:
  # Test HRL branch (expected to fail - demonstrates Issue #1)
  test-hrl-baseline:
    name: HRL Branch Test (Expected Failure)
    if: inputs.test_suite == 'all' || inputs.test_suite == 'basic'
    continue-on-error: true
    uses: huntridge-labs/hardening-workflows/.github/workflows/reusable-security-hardening.yml@feat/zap-scanner
    with:
      scanners: 'zap'
      zap_scan_mode: 'url'
      zap_scan_type: 'baseline'
      zap_target_urls: 'http://demo.testfire.net'
      allow_failure: true
    secrets: inherit

  # Test with fixes applied (fork) - URL Mode
  test-zap-url:
    name: Fork with Fixes - URL Mode
    needs: [test-hrl-baseline]
    if: always() && (inputs.test_suite == 'all' || inputs.test_suite == 'basic')
    uses: 1blt/hardening-workflows/.github/workflows/reusable-security-hardening.yml@feat/zap-scanner-fixes-250112
    with:
      scanners: 'zap'
      zap_scan_mode: 'url'
      zap_scan_type: 'baseline'
      zap_target_urls: 'http://demo.testfire.net'
      allow_failure: true
    secrets: inherit

  # Test with fixes applied (fork) - Docker Mode
  test-zap-docker:
    name: Fork with Fixes - Docker Mode
    needs: [test-zap-url]
    if: always() && (inputs.test_suite == 'all' || inputs.test_suite == 'basic')
    uses: 1blt/hardening-workflows/.github/workflows/reusable-security-hardening.yml@feat/zap-scanner-fixes-250112
    with:
      scanners: 'zap'
      zap_scan_mode: 'docker-run'
      zap_scan_type: 'baseline'
      zap_app_image_ref: 'bkimminich/juice-shop:latest'
      zap_app_ports: '3000:3000'
      zap_target_urls: 'http://localhost:3000'
      allow_failure: true
    secrets: inherit

  # Test with fixes applied (fork) - Threshold test
  test-threshold:
    name: Fork with Fixes - Threshold Test
    needs: [test-zap-docker]
    if: always() && (inputs.test_suite == 'all' || inputs.test_suite == 'basic')
    uses: 1blt/hardening-workflows/.github/workflows/reusable-security-hardening.yml@feat/zap-scanner-fixes-250112
    with:
      scanners: 'zap'
      zap_scan_mode: 'url'
      zap_scan_type: 'baseline'
      zap_target_urls: 'http://testphp.vulnweb.com'
      allow_failure: true
      severity_threshold: 'high'
    secrets: inherit

  # Summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-hrl-baseline, test-zap-url, test-zap-docker, test-threshold]
    if: always()
    steps:
      - name: Check Test Results
        run: |
          echo "## Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### HRL Branch (feat/zap-scanner)" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| HRL Baseline | ${{ needs.test-hrl-baseline.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Fork with Fixes (1blt/feat/zap-scanner-fixes-250112)" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| URL Mode | ${{ needs.test-zap-url.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Mode | ${{ needs.test-zap-docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Threshold Test | ${{ needs.test-threshold.result }} |" >> $GITHUB_STEP_SUMMARY
