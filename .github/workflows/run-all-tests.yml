name: HRL ZAP Configuration Tests

on:
  workflow_dispatch:
    inputs:
      config:
        description: 'Test configuration'
        required: true
        type: choice
        options:
          - reliable       # 7 tests: self-hosted containers (recommended)
          - full-coverage  # 7 tests: sequential external URLs
          - minimal        # 2 URL scans
          - docker         # 1 Docker scan only
        default: 'reliable'

permissions:
  actions: read
  checks: write
  pull-requests: write
  security-events: write
  id-token: write
  contents: read

jobs:
  # =============================================================================
  # RELIABLE MODE - Self-hosted containers for guaranteed results
  # =============================================================================
  # Tests 1-4: juice-shop (known vulnerabilities)
  # Test 5: podinfo (clean app - validates low false positives)
  # Tests 6-7: External URL (real-world sanity check)
  # =============================================================================

  reliable-vuln:
    name: "Tests 1-4: Juice Shop (known vulns)"
    if: inputs.config == 'reliable'
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/reliable-test.yml
    secrets: inherit

  reliable-clean:
    name: "Test 5: Podinfo (clean app)"
    if: inputs.config == 'reliable'
    needs: reliable-vuln
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/reliable-clean.yml
    secrets: inherit

  reliable-external:
    name: "Tests 6-7: External URL"
    if: inputs.config == 'reliable'
    needs: reliable-clean
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/reliable-external.yml
    secrets: inherit

  # =============================================================================
  # FULL COVERAGE MODE - 7 sequential tests
  # =============================================================================

  test-1:
    name: "1/7 URL Baseline"
    if: inputs.config == 'full-coverage'
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/test-1-baseline.yml
    secrets: inherit

  test-2:
    name: "2/7 URL Full"
    if: inputs.config == 'full-coverage'
    needs: test-1
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/test-2-full.yml
    secrets: inherit

  test-3:
    name: "3/7 URL API"
    if: inputs.config == 'full-coverage'
    needs: test-2
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/test-3-api.yml
    secrets: inherit

  test-4:
    name: "4/7 Threshold High"
    if: inputs.config == 'full-coverage'
    needs: test-3
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/test-4-threshold.yml
    secrets: inherit

  test-5:
    name: "5/7 Threshold Medium"
    if: inputs.config == 'full-coverage'
    needs: test-4
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/test-5-medium.yml
    secrets: inherit

  test-6:
    name: "6/7 Short Duration"
    if: inputs.config == 'full-coverage'
    needs: test-5
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/test-6-duration.yml
    secrets: inherit

  test-7:
    name: "7/7 Docker Mode"
    if: inputs.config == 'full-coverage'
    needs: test-6
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/test-7-docker.yml
    secrets: inherit

  # =============================================================================
  # SINGLE CONFIG MODES
  # =============================================================================

  single-config:
    name: "ZAP Scan (${{ inputs.config }})"
    if: inputs.config == 'minimal' || inputs.config == 'docker'
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/${{ inputs.config }}-test.yml
    secrets: inherit

  # =============================================================================
  # GO/NO-GO REPORT
  # =============================================================================

  summary:
    name: "GO/NO-GO Report"
    runs-on: ubuntu-latest
    needs: [reliable-vuln, reliable-clean, reliable-external, test-1, test-2, test-3, test-4, test-5, test-6, test-7, single-config]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate Report
        env:
          R_VULN: ${{ needs.reliable-vuln.result }}
          R_CLEAN: ${{ needs.reliable-clean.result }}
          R_EXT: ${{ needs.reliable-external.result }}
          T1: ${{ needs.test-1.result }}
          T2: ${{ needs.test-2.result }}
          T3: ${{ needs.test-3.result }}
          T4: ${{ needs.test-4.result }}
          T5: ${{ needs.test-5.result }}
          T6: ${{ needs.test-6.result }}
          T7: ${{ needs.test-7.result }}
          SINGLE: ${{ needs.single-config.result }}
          CONFIG: ${{ inputs.config }}
        run: |
          echo "# ZAP Configuration Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Config:** \`$CONFIG\`" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$CONFIG" = "reliable" ]; then
            echo "**Mode:** Reliable (self-hosted containers)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Count passes (skipped jobs don't count as failures)
            PASSED=0
            FAILED=0
            for r in "$R_VULN" "$R_CLEAN" "$R_EXT"; do
              case "$r" in
                success) PASSED=$((PASSED + 1)) ;;
                failure) FAILED=$((FAILED + 1)) ;;
              esac
            done

            TOTAL=$((PASSED + FAILED))
            [ $TOTAL -eq 0 ] && TOTAL=1  # Avoid division by zero
            PASS_RATE=$((PASSED * 100 / TOTAL))
            [ $FAILED -eq 0 ] && DECISION="GO" || DECISION="NO-GO"
            [ "$DECISION" = "GO" ] && ICON="[PASS]" || ICON="[FAIL]"

            echo "## $ICON DETERMINATION: $DECISION" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Pass Rate:** $PASSED/$TOTAL jobs ($PASS_RATE%)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Job | Tests | Target | Result |" >> $GITHUB_STEP_SUMMARY
            echo "|-----|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY

            fmt() { [ "$1" = "success" ] && echo "[PASS]" || echo "[FAIL]"; }

            echo "| Juice Shop | 4 scans | localhost:3000 | $(fmt "$R_VULN") $R_VULN |" >> $GITHUB_STEP_SUMMARY
            echo "| Podinfo | 1 scan | localhost:9898 | $(fmt "$R_CLEAN") $R_CLEAN |" >> $GITHUB_STEP_SUMMARY
            echo "| External | 2 scans | demo.testfire.net | $(fmt "$R_EXT") $R_EXT |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Coverage (7 Tests)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| # | Test | Mode | Type | Threshold | Target |" >> $GITHUB_STEP_SUMMARY
            echo "|---|------|------|------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| 1 | juice-baseline | docker | baseline | none | juice-shop |" >> $GITHUB_STEP_SUMMARY
            echo "| 2 | juice-full | docker | full | none | juice-shop |" >> $GITHUB_STEP_SUMMARY
            echo "| 3 | threshold-high | docker | baseline | high | juice-shop |" >> $GITHUB_STEP_SUMMARY
            echo "| 4 | threshold-medium | docker | baseline | medium | juice-shop |" >> $GITHUB_STEP_SUMMARY
            echo "| 5 | clean-baseline | docker | baseline | medium | podinfo |" >> $GITHUB_STEP_SUMMARY
            echo "| 6 | external-baseline | url | baseline | none | testfire.net |" >> $GITHUB_STEP_SUMMARY
            echo "| 7 | external-quick | url | baseline | none | testfire.net |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Why This Suite is Reliable" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Aspect | Approach |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
            echo "| Availability | 5/7 tests use self-hosted Docker containers |" >> $GITHUB_STEP_SUMMARY
            echo "| Reproducibility | juice-shop has documented, consistent vulns |" >> $GITHUB_STEP_SUMMARY
            echo "| Validation | podinfo (clean app) verifies low false-positives |" >> $GITHUB_STEP_SUMMARY
            echo "| Real-world | 2 external URL tests for sanity check |" >> $GITHUB_STEP_SUMMARY

          elif [ "$CONFIG" = "full-coverage" ]; then
            echo "**Mode:** Full Coverage (sequential)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            PASSED=0
            for r in "$T1" "$T2" "$T3" "$T4" "$T5" "$T6" "$T7"; do
              [ "$r" = "success" ] && PASSED=$((PASSED + 1))
            done

            [ $PASSED -eq 7 ] && DECISION="GO" || DECISION="NO-GO"
            [ "$DECISION" = "GO" ] && ICON="[PASS]" || ICON="[FAIL]"

            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## $ICON DETERMINATION: $DECISION" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Pass Rate:** $PASSED/7" >> $GITHUB_STEP_SUMMARY

          else
            [ "$SINGLE" = "success" ] && DECISION="GO" || DECISION="NO-GO"
            [ "$DECISION" = "GO" ] && ICON="[PASS]" || ICON="[FAIL]"

            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## $ICON DETERMINATION: $DECISION" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Test | Result |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| $CONFIG | $ICON $SINGLE |" >> $GITHUB_STEP_SUMMARY
          fi
