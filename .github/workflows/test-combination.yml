name: "Combination Tests"

on:
  workflow_call:
    outputs:
      results:
        description: "JSON array of individual test results"
        value: ${{ jobs.validate-results.outputs.results }}

permissions:
  contents: read
  security-events: write
  actions: read
  packages: read
  pull-requests: write

# ============================================================================
# Combination / pairwise tests: exercise untested parameter combinations
#
# Parameters: mode × scanners × severity × allow_failure × image
#
# These tests fill gaps identified by pairwise coverage analysis:
# - Scanner pairs never tested: trivy+syft, grype+syft
# - Severity levels never tested standalone: medium, high (without allow_failure)
# - Grype never threshold-tested
# - Discover mode gaps: grype-only, syft-only, all-scanners, allow_failure
# - allow_failure never tested with multi-scanner or discover mode
# ============================================================================

jobs:
  # --------------------------------------------------------------------------
  # Scanner pair coverage
  # --------------------------------------------------------------------------

  # C1: trivy+syft pair (never tested together)
  c1-trivy-syft:
    name: "C1: trivy+syft pair"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: nginx:1.19.0
      container_name: c1-trivy-syft
      scanners: trivy,syft
      fail_on_severity: none
      allow_failure: false

  # C2: grype+syft pair (never tested together)
  c2-grype-syft:
    name: "C2: grype+syft pair"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: nginx:1.19.0
      container_name: c2-grype-syft
      scanners: grype,syft
      fail_on_severity: none
      allow_failure: false

  # --------------------------------------------------------------------------
  # Severity enforcement — filling medium, high, and grype threshold gaps
  # --------------------------------------------------------------------------

  # C3: medium threshold on vulnerable image (medium severity never tested)
  c3-medium-vuln:
    name: "C3: medium threshold on vuln"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: nginx:1.19.0
      container_name: c3-medium-vuln
      scanners: trivy
      fail_on_severity: medium
      allow_failure: false

  # C4: high threshold standalone (R8 masks with allow_failure=true)
  c4-high-vuln:
    name: "C4: high threshold on vuln"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: nginx:1.19.0
      container_name: c4-high-vuln
      scanners: grype
      fail_on_severity: high
      allow_failure: false

  # C5: grype + critical threshold (grype never threshold-tested)
  c5-grype-critical:
    name: "C5: grype + critical threshold"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: nginx:1.19.0
      container_name: c5-grype-critical
      scanners: grype
      fail_on_severity: critical
      allow_failure: false

  # C6: low threshold on alpine (has low/med vulns — should trigger)
  c6-low-alpine:
    name: "C6: low threshold on alpine"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: alpine:3.18
      container_name: c6-low-alpine
      scanners: trivy
      fail_on_severity: low
      allow_failure: false

  # C7: high threshold on alpine (med/low vulns — should pass)
  c7-high-alpine:
    name: "C7: high threshold on alpine"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: alpine:3.18
      container_name: c7-high-alpine
      scanners: trivy,grype
      fail_on_severity: high
      allow_failure: false

  # --------------------------------------------------------------------------
  # allow_failure combinations
  # --------------------------------------------------------------------------

  # C8: multi-scanner + allow_failure (only single-scanner tested in R8)
  c8-allow-multi-scanner:
    name: "C8: allow_failure + multi-scanner"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: nginx:1.19.0
      container_name: c8-allow-multi
      scanners: trivy,grype
      fail_on_severity: critical
      allow_failure: true

  # C9: grype + allow_failure + clean image (grype×true, low×true, true×clean)
  c9-allow-grype-clean:
    name: "C9: allow_failure + grype + clean"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: gcr.io/distroless/static-debian12:latest
      container_name: c9-allow-grype-clean
      scanners: grype
      fail_on_severity: low
      allow_failure: true

  # C10: discover + allow_failure (never tested)
  c10-discover-allow:
    name: "C10: discover + allow_failure"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: discover
      scanners: trivy
      fail_on_severity: medium
      allow_failure: true

  # --------------------------------------------------------------------------
  # Discover mode expansion
  # --------------------------------------------------------------------------

  # C11: discover + grype only (never tested)
  c11-discover-grype:
    name: "C11: discover grype only"
    needs: c10-discover-allow
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: discover
      scanners: grype
      fail_on_severity: low
      allow_failure: false

  # C12: discover + all scanners (never tested)
  c12-discover-all:
    name: "C12: discover all scanners"
    needs: c11-discover-grype
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: discover
      scanners: trivy,grype,syft
      fail_on_severity: none
      allow_failure: false

  # C13: discover + syft only + high threshold
  c13-discover-syft:
    name: "C13: discover syft only"
    needs: c12-discover-all
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: discover
      scanners: syft
      fail_on_severity: high
      allow_failure: false

  # --------------------------------------------------------------------------
  # Multi-scanner + threshold (cross-cutting)
  # --------------------------------------------------------------------------

  # C14: all scanners + high threshold + allow_failure on low-vuln image
  c14-all-high-alpine:
    name: "C14: all scanners + high + allow_failure"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: alpine:3.18
      container_name: c14-all-high-alpine
      scanners: trivy,grype,syft
      fail_on_severity: high
      allow_failure: true

  # C15: multi-scanner + medium threshold on clean image (should pass)
  c15-medium-clean:
    name: "C15: medium threshold on clean"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: gcr.io/distroless/static-debian12:latest
      container_name: c15-medium-clean
      scanners: trivy,grype
      fail_on_severity: medium
      allow_failure: false

  # --------------------------------------------------------------------------
  # Validation job
  # --------------------------------------------------------------------------
  validate-results:
    name: "Validate Combination Test Results"
    runs-on: ubuntu-latest
    outputs:
      results: ${{ steps.collect.outputs.results }}
    needs:
      - c1-trivy-syft
      - c2-grype-syft
      - c3-medium-vuln
      - c4-high-vuln
      - c5-grype-critical
      - c6-low-alpine
      - c7-high-alpine
      - c8-allow-multi-scanner
      - c9-allow-grype-clean
      - c10-discover-allow
      - c11-discover-grype
      - c12-discover-all
      - c13-discover-syft
      - c14-all-high-alpine
      - c15-medium-clean
    if: always()
    steps:
      - name: Validate test outcomes
        env:
          C1: ${{ needs.c1-trivy-syft.result }}
          C2: ${{ needs.c2-grype-syft.result }}
          C3: ${{ needs.c3-medium-vuln.result }}
          C4: ${{ needs.c4-high-vuln.result }}
          C5: ${{ needs.c5-grype-critical.result }}
          C6: ${{ needs.c6-low-alpine.result }}
          C7: ${{ needs.c7-high-alpine.result }}
          C8: ${{ needs.c8-allow-multi-scanner.result }}
          C9: ${{ needs.c9-allow-grype-clean.result }}
          C10: ${{ needs.c10-discover-allow.result }}
          C11: ${{ needs.c11-discover-grype.result }}
          C12: ${{ needs.c12-discover-all.result }}
          C13: ${{ needs.c13-discover-syft.result }}
          C14: ${{ needs.c14-all-high-alpine.result }}
          C15: ${{ needs.c15-medium-clean.result }}
        run: |
          FAILURES=0

          check() {
            local name="$1" got="$2" expected="$3"
            if [ "$got" = "$expected" ]; then
              echo "PASS $name: $got (expected $expected)"
            else
              echo "FAIL $name: $got (expected $expected)"
              FAILURES=$((FAILURES + 1))
            fi
          }

          echo "============================================"
          echo "Combination Test Validation"
          echo "============================================"
          echo ""

          # Scanner pair tests — should succeed (no threshold enforcement)
          check "C1  trivy+syft pair" "$C1" "success"
          check "C2  grype+syft pair" "$C2" "success"

          # Severity enforcement — container-scan.yml uses continue-on-error,
          # so threshold enforcement happens internally but the reusable
          # workflow returns 'success'. We validate the code path executes.
          check "C3  medium threshold on vuln" "$C3" "success"
          check "C4  high threshold on vuln" "$C4" "success"
          check "C5  grype + critical threshold" "$C5" "success"
          check "C6  low threshold on alpine" "$C6" "success"
          check "C7  high threshold on alpine" "$C7" "success"

          # allow_failure — should always succeed
          check "C8  allow_failure + multi-scanner" "$C8" "success"
          check "C9  allow_failure + grype + clean" "$C9" "success"
          check "C10 discover + allow_failure" "$C10" "success"

          # Discover expansion — should succeed
          check "C11 discover grype only" "$C11" "success"
          check "C12 discover all scanners" "$C12" "success"
          check "C13 discover syft only" "$C13" "success"

          # Cross-cutting
          check "C14 all scanners + high + allow" "$C14" "success"
          check "C15 medium threshold on clean" "$C15" "success"

          echo ""
          echo "============================================"
          TOTAL=15
          PASSED=$((TOTAL - FAILURES))
          echo "Results: $PASSED/$TOTAL passed"
          echo "============================================"

          if [ "$FAILURES" -gt 0 ]; then
            echo "::error::$FAILURES combination test(s) did not produce expected outcome"
            exit 1
          fi

      - name: Build results JSON
        id: collect
        if: always()
        env:
          C1: ${{ needs.c1-trivy-syft.result }}
          C2: ${{ needs.c2-grype-syft.result }}
          C3: ${{ needs.c3-medium-vuln.result }}
          C4: ${{ needs.c4-high-vuln.result }}
          C5: ${{ needs.c5-grype-critical.result }}
          C6: ${{ needs.c6-low-alpine.result }}
          C7: ${{ needs.c7-high-alpine.result }}
          C8: ${{ needs.c8-allow-multi-scanner.result }}
          C9: ${{ needs.c9-allow-grype-clean.result }}
          C10: ${{ needs.c10-discover-allow.result }}
          C11: ${{ needs.c11-discover-grype.result }}
          C12: ${{ needs.c12-discover-all.result }}
          C13: ${{ needs.c13-discover-syft.result }}
          C14: ${{ needs.c14-all-high-alpine.result }}
          C15: ${{ needs.c15-medium-clean.result }}
        run: |
          to_status() {
            case "$1" in
              success) echo "pass" ;;
              failure) echo "FAIL" ;;
              skipped) echo "skip" ;;
              cancelled) echo "cancel" ;;
              *) echo "unknown" ;;
            esac
          }
          RESULTS=$(jq -n -c \
            --arg c1 "$(to_status "$C1")" \
            --arg c2 "$(to_status "$C2")" \
            --arg c3 "$(to_status "$C3")" \
            --arg c4 "$(to_status "$C4")" \
            --arg c5 "$(to_status "$C5")" \
            --arg c6 "$(to_status "$C6")" \
            --arg c7 "$(to_status "$C7")" \
            --arg c8 "$(to_status "$C8")" \
            --arg c9 "$(to_status "$C9")" \
            --arg c10 "$(to_status "$C10")" \
            --arg c11 "$(to_status "$C11")" \
            --arg c12 "$(to_status "$C12")" \
            --arg c13 "$(to_status "$C13")" \
            --arg c14 "$(to_status "$C14")" \
            --arg c15 "$(to_status "$C15")" \
            '[
              {"id":"C1","name":"trivy+syft pair","detail":"remote nginx:1.19.0 — untested scanner pair (TS)","status":$c1},
              {"id":"C2","name":"grype+syft pair","detail":"remote nginx:1.19.0 — untested scanner pair (GS)","status":$c2},
              {"id":"C3","name":"medium threshold on vuln","detail":"remote nginx:1.19.0 trivy severity=medium — untested threshold","status":$c3},
              {"id":"C4","name":"high threshold on vuln","detail":"remote nginx:1.19.0 grype severity=high — standalone (no allow_failure)","status":$c4},
              {"id":"C5","name":"grype + critical threshold","detail":"remote nginx:1.19.0 grype severity=critical — grype never threshold-tested","status":$c5},
              {"id":"C6","name":"low threshold on alpine","detail":"remote alpine:3.18 trivy severity=low — should trigger on low-vuln image","status":$c6},
              {"id":"C7","name":"high threshold on alpine","detail":"remote alpine:3.18 trivy+grype severity=high — TN precision on low-vuln","status":$c7},
              {"id":"C8","name":"allow_failure + multi-scanner","detail":"remote nginx:1.19.0 trivy+grype severity=critical allow_failure=true","status":$c8},
              {"id":"C9","name":"allow_failure + grype + clean","detail":"remote distroless grype severity=low allow_failure=true","status":$c9},
              {"id":"C10","name":"discover + allow_failure","detail":"discover trivy severity=medium allow_failure=true — never tested","status":$c10},
              {"id":"C11","name":"discover grype only","detail":"discover grype severity=low — grype-only discover never tested","status":$c11},
              {"id":"C12","name":"discover all scanners","detail":"discover trivy+grype+syft severity=none — all scanners discover","status":$c12},
              {"id":"C13","name":"discover syft only","detail":"discover syft severity=high — syft-only discover never tested","status":$c13},
              {"id":"C14","name":"all scanners + high + allow","detail":"remote alpine:3.18 TGS severity=high allow_failure=true","status":$c14},
              {"id":"C15","name":"medium threshold on clean","detail":"remote distroless trivy+grype severity=medium — TN on clean image","status":$c15}
            ]')
          echo "results=$RESULTS" >> "$GITHUB_OUTPUT"
