name: "Remote Mode Tests"

on:
  workflow_call:

permissions:
  contents: read
  security-events: write
  actions: read
  packages: read
  pull-requests: write

# ============================================================================
# Remote mode tests: scan pre-existing images via container-scan.yml
#
# Tests R1-R12 cover:
# - True positive detection (R1, R6, R12)
# - True negative detection (R2, R10)
# - Scanner isolation (R3, R4, R5)
# - Threshold precision (R7, R11)
# - Error handling (R8, R9)
# ============================================================================

jobs:
  # --------------------------------------------------------------------------
  # R1: Vulnerable image + all scanners (TP-detect)
  # --------------------------------------------------------------------------
  r1-vuln-all-scanners:
    name: "R1: vuln + all scanners"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: nginx:1.19.0
      container_name: r1-nginx-vuln
      scanners: trivy,grype,syft
      fail_on_severity: none
      allow_failure: false

  # --------------------------------------------------------------------------
  # R2: Clean image (TN-detect)
  # --------------------------------------------------------------------------
  r2-clean-image:
    name: "R2: clean image"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: gcr.io/distroless/static-debian12:latest
      container_name: r2-distroless-clean
      scanners: trivy,grype
      fail_on_severity: none
      allow_failure: false

  # --------------------------------------------------------------------------
  # R3: Trivy only (scanner isolation)
  # --------------------------------------------------------------------------
  r3-trivy-only:
    name: "R3: trivy only"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: alpine:3.18
      container_name: r3-alpine-trivy
      scanners: trivy
      fail_on_severity: none
      allow_failure: false

  # --------------------------------------------------------------------------
  # R4: Grype only (scanner isolation)
  # --------------------------------------------------------------------------
  r4-grype-only:
    name: "R4: grype only"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: alpine:3.18
      container_name: r4-alpine-grype
      scanners: grype
      fail_on_severity: none
      allow_failure: false

  # --------------------------------------------------------------------------
  # R5: Syft only (SBOM generation, no vuln scan)
  # --------------------------------------------------------------------------
  r5-syft-only:
    name: "R5: syft only"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: alpine:3.18
      container_name: r5-alpine-syft
      scanners: syft
      fail_on_severity: none
      allow_failure: false

  # --------------------------------------------------------------------------
  # R6: Vulnerable image + critical threshold -> should FAIL (TP-threshold)
  # Uses continue-on-error so the workflow continues to the validation job
  # --------------------------------------------------------------------------
  r6-fail-critical:
    name: "R6: fail on critical"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: nginx:1.19.0
      container_name: r6-nginx-critical
      scanners: trivy,grype
      fail_on_severity: critical
      allow_failure: false

  # --------------------------------------------------------------------------
  # R7: Vulnerable image + threshold=none -> should PASS (TN-threshold)
  # --------------------------------------------------------------------------
  r7-pass-none:
    name: "R7: pass with none threshold"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: nginx:1.19.0
      container_name: r7-nginx-none
      scanners: trivy,grype
      fail_on_severity: none
      allow_failure: false

  # --------------------------------------------------------------------------
  # R8: Vulnerable image + allow_failure=true -> should PASS (allow_failure)
  # --------------------------------------------------------------------------
  r8-allow-failure:
    name: "R8: allow failure"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: nginx:1.19.0
      container_name: r8-nginx-allow
      scanners: trivy
      fail_on_severity: high
      allow_failure: true

  # --------------------------------------------------------------------------
  # R9: Bad image reference -> graceful error (error handling)
  # --------------------------------------------------------------------------
  r9-bad-image:
    name: "R9: bad image"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: nonexistent/nosuchimage:v0
      container_name: r9-bad-image
      scanners: trivy
      fail_on_severity: none
      allow_failure: false

  # --------------------------------------------------------------------------
  # R10: Clean image + strict threshold -> should PASS (TN-threshold)
  # --------------------------------------------------------------------------
  r10-clean-strict:
    name: "R10: clean + strict threshold"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: gcr.io/distroless/static-debian12:latest
      container_name: r10-distroless-strict
      scanners: trivy,grype
      fail_on_severity: low
      allow_failure: false

  # --------------------------------------------------------------------------
  # R11: Alpine (med/low vulns) + critical threshold -> should PASS (TN-precision)
  # --------------------------------------------------------------------------
  r11-threshold-precision:
    name: "R11: threshold precision"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: alpine:3.18
      container_name: r11-alpine-precision
      scanners: trivy,grype
      fail_on_severity: critical
      allow_failure: false

  # --------------------------------------------------------------------------
  # R12: Deduplication validation (cross-scanner dedup)
  # --------------------------------------------------------------------------
  r12-dedup-validation:
    name: "R12: dedup validation"
    uses: huntridge-labs/hardening-workflows/.github/workflows/container-scan.yml@feat/migrate-to-composite-actions
    with:
      scan_mode: remote
      image_ref: nginx:1.19.0
      container_name: r12-nginx-dedup
      scanners: trivy,grype
      fail_on_severity: none
      allow_failure: false

  # --------------------------------------------------------------------------
  # Validation job: verify expected outcomes
  # --------------------------------------------------------------------------
  validate-results:
    name: "Validate Remote Test Results"
    runs-on: ubuntu-latest
    needs:
      - r1-vuln-all-scanners
      - r2-clean-image
      - r3-trivy-only
      - r4-grype-only
      - r5-syft-only
      - r6-fail-critical
      - r7-pass-none
      - r8-allow-failure
      - r9-bad-image
      - r10-clean-strict
      - r11-threshold-precision
      - r12-dedup-validation
    if: always()
    steps:
      - name: Validate test outcomes
        env:
          R1: ${{ needs.r1-vuln-all-scanners.result }}
          R2: ${{ needs.r2-clean-image.result }}
          R3: ${{ needs.r3-trivy-only.result }}
          R4: ${{ needs.r4-grype-only.result }}
          R5: ${{ needs.r5-syft-only.result }}
          R6: ${{ needs.r6-fail-critical.result }}
          R7: ${{ needs.r7-pass-none.result }}
          R8: ${{ needs.r8-allow-failure.result }}
          R9: ${{ needs.r9-bad-image.result }}
          R10: ${{ needs.r10-clean-strict.result }}
          R11: ${{ needs.r11-threshold-precision.result }}
          R12: ${{ needs.r12-dedup-validation.result }}
        run: |
          FAILURES=0

          check() {
            local name="$1" got="$2" expected="$3"
            if [ "$got" = "$expected" ]; then
              echo "PASS $name: $got (expected $expected)"
            else
              echo "FAIL $name: $got (expected $expected)"
              FAILURES=$((FAILURES + 1))
            fi
          }

          echo "============================================"
          echo "Remote Mode Test Validation"
          echo "============================================"
          echo ""

          # Tests that should succeed
          check "R1  remote-vuln-all-scanners" "$R1" "success"
          check "R2  remote-clean-image" "$R2" "success"
          check "R3  remote-trivy-only" "$R3" "success"
          check "R4  remote-grype-only" "$R4" "success"
          check "R5  remote-syft-only" "$R5" "success"

          # R6 should FAIL (critical threshold on vulnerable image)
          check "R6  remote-fail-critical" "$R6" "failure"

          # R7 should PASS (threshold=none)
          check "R7  remote-pass-none" "$R7" "success"

          # R8 should PASS (allow_failure=true)
          check "R8  remote-allow-failure" "$R8" "success"

          # R9 may fail (bad image) - we just check it didn't cause a crash
          # Both 'failure' and 'success' are acceptable (depends on error handling)
          if [ "$R9" = "success" ] || [ "$R9" = "failure" ]; then
            echo "PASS R9  remote-bad-image: $R9 (completed without crash)"
          else
            echo "FAIL R9  remote-bad-image: $R9 (unexpected state)"
            FAILURES=$((FAILURES + 1))
          fi

          # R10 should PASS (clean image + strict threshold)
          check "R10 remote-clean-strict" "$R10" "success"

          # R11 should PASS (medium vulns + critical threshold)
          check "R11 remote-threshold-precision" "$R11" "success"

          # R12 should PASS (dedup validation)
          check "R12 remote-dedup-validation" "$R12" "success"

          echo ""
          echo "============================================"
          TOTAL=12
          PASSED=$((TOTAL - FAILURES))
          echo "Results: $PASSED/$TOTAL passed"
          echo "============================================"

          if [ "$FAILURES" -gt 0 ]; then
            echo "::error::$FAILURES remote test(s) did not produce expected outcome"
            exit 1
          fi

      - name: Generate summary
        if: always()
        env:
          R1: ${{ needs.r1-vuln-all-scanners.result }}
          R2: ${{ needs.r2-clean-image.result }}
          R3: ${{ needs.r3-trivy-only.result }}
          R4: ${{ needs.r4-grype-only.result }}
          R5: ${{ needs.r5-syft-only.result }}
          R6: ${{ needs.r6-fail-critical.result }}
          R7: ${{ needs.r7-pass-none.result }}
          R8: ${{ needs.r8-allow-failure.result }}
          R9: ${{ needs.r9-bad-image.result }}
          R10: ${{ needs.r10-clean-strict.result }}
          R11: ${{ needs.r11-threshold-precision.result }}
          R12: ${{ needs.r12-dedup-validation.result }}
        run: |
          icon() {
            local got="$1" expected="$2"
            [ "$got" = "$expected" ] && echo "pass" || echo "FAIL"
          }

          {
            cat << 'HEADER'
          ## Remote Mode Test Results

          | # | Test | Image | Expected | Actual | Status |
          |---|------|-------|----------|--------|--------|
          HEADER
            echo "| R1 | vuln + all scanners | nginx:1.19.0 | success | ${R1} | $(icon "${R1}" success) |"
            echo "| R2 | clean image | distroless/static | success | ${R2} | $(icon "${R2}" success) |"
            echo "| R3 | trivy only | alpine:3.18 | success | ${R3} | $(icon "${R3}" success) |"
            echo "| R4 | grype only | alpine:3.18 | success | ${R4} | $(icon "${R4}" success) |"
            echo "| R5 | syft only | alpine:3.18 | success | ${R5} | $(icon "${R5}" success) |"
            echo "| R6 | fail on critical | nginx:1.19.0 | failure | ${R6} | $(icon "${R6}" failure) |"
            echo "| R7 | pass with none | nginx:1.19.0 | success | ${R7} | $(icon "${R7}" success) |"
            echo "| R8 | allow failure | nginx:1.19.0 | success | ${R8} | $(icon "${R8}" success) |"
            echo "| R9 | bad image | nonexistent | completed | ${R9} | $(icon "${R9}" "${R9}") |"
            echo "| R10 | clean + strict | distroless/static | success | ${R10} | $(icon "${R10}" success) |"
            echo "| R11 | threshold precision | alpine:3.18 | success | ${R11} | $(icon "${R11}" success) |"
            echo "| R12 | dedup validation | nginx:1.19.0 | success | ${R12} | $(icon "${R12}" success) |"
          } >> "$GITHUB_STEP_SUMMARY"
